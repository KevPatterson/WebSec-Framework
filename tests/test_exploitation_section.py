#!/usr/bin/env python3
"""
Test para verificar la secci√≥n de explotaci√≥n en reportes HTML.
"""

import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from core.html_reporter import HTMLReporter
from datetime import datetime

def test_exploitation_section():
    """Prueba la generaci√≥n de informaci√≥n de explotaci√≥n."""
    
    # Datos de prueba con diferentes tipos de vulnerabilidades
    test_data = {
        'scan_info': {
            'target': 'http://testphp.vulnweb.com',
            'timestamp': datetime.now().strftime('%Y%m%d_%H%M%S'),
            'modules_executed': 'XSS, SQLi, CSRF, LFI, SSRF, XXE, CORS, Auth, Headers'
        },
        'summary': {
            'critical': 2,
            'high': 3,
            'medium': 2,
            'low': 1,
            'info': 1
        },
        'all_findings': [
            {
                'type': 'xss',
                'severity': 'high',
                'title': 'Cross-Site Scripting (XSS) Reflejado',
                'vulnerability': 'XSS Reflected',
                'description': 'Se detect√≥ una vulnerabilidad XSS que permite inyectar c√≥digo JavaScript.',
                'recommendation': 'Implementar validaci√≥n y sanitizaci√≥n de entrada. Usar Content Security Policy.',
                'cvss': 7.5,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/search.php',
                    'parameter': 'q',
                    'payload': '<script>alert(1)</script>'
                }
            },
            {
                'type': 'sqli',
                'severity': 'critical',
                'title': 'SQL Injection en par√°metro ID',
                'vulnerability': 'SQL Injection',
                'description': 'Vulnerabilidad de inyecci√≥n SQL que permite manipular consultas a la base de datos.',
                'recommendation': 'Usar prepared statements y parametrized queries. Validar entrada.',
                'cvss': 9.8,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/artists.php',
                    'parameter': 'artist',
                    'payload': "1' OR '1'='1"
                }
            },
            {
                'type': 'csrf',
                'severity': 'medium',
                'title': 'Cross-Site Request Forgery en cambio de email',
                'vulnerability': 'CSRF',
                'description': 'No se valida token CSRF en operaciones sensibles.',
                'recommendation': 'Implementar tokens CSRF √∫nicos por sesi√≥n y validarlos en el servidor.',
                'cvss': 6.5,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/profile/update',
                    'parameter': 'email'
                }
            },
            {
                'type': 'lfi',
                'severity': 'high',
                'title': 'Local File Inclusion',
                'vulnerability': 'LFI',
                'description': 'Permite leer archivos arbitrarios del servidor.',
                'recommendation': 'Validar y sanitizar rutas de archivos. Usar whitelist.',
                'cvss': 7.8,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/include.php',
                    'parameter': 'file'
                }
            },
            {
                'type': 'ssrf',
                'severity': 'high',
                'title': 'Server-Side Request Forgery',
                'vulnerability': 'SSRF',
                'description': 'El servidor realiza requests a URLs arbitrarias.',
                'recommendation': 'Validar y restringir URLs permitidas. Usar whitelist.',
                'cvss': 8.2,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/fetch.php',
                    'parameter': 'url'
                }
            },
            {
                'type': 'xxe',
                'severity': 'critical',
                'title': 'XML External Entity Injection',
                'vulnerability': 'XXE',
                'description': 'Procesamiento inseguro de entidades XML externas.',
                'recommendation': 'Deshabilitar entidades externas en el parser XML.',
                'cvss': 9.1,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/api/xml'
                }
            },
            {
                'type': 'cors',
                'severity': 'medium',
                'title': 'CORS Misconfiguration',
                'vulnerability': 'CORS',
                'description': 'Configuraci√≥n permisiva de CORS permite acceso desde cualquier origen.',
                'recommendation': 'Configurar CORS con lista espec√≠fica de or√≠genes permitidos.',
                'cvss': 5.8,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/api/data'
                }
            },
            {
                'type': 'auth',
                'severity': 'high',
                'title': 'Authentication Bypass',
                'vulnerability': 'Auth Bypass',
                'description': 'Posible bypass de autenticaci√≥n mediante SQL injection.',
                'recommendation': 'Implementar autenticaci√≥n robusta con prepared statements.',
                'cvss': 8.5,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com/login.php'
                }
            },
            {
                'type': 'headers',
                'severity': 'low',
                'title': 'Missing Security Headers',
                'vulnerability': 'Security Headers',
                'description': 'Faltan headers de seguridad importantes.',
                'recommendation': 'Implementar X-Frame-Options, CSP, HSTS, etc.',
                'cvss': 3.7,
                'evidence': {
                    'url': 'http://testphp.vulnweb.com',
                    'missing_headers': ['X-Frame-Options', 'Content-Security-Policy']
                }
            }
        ]
    }
    
    # Crear reporte
    reporter = HTMLReporter()
    output_path = 'reports/test_exploitation_report.html'
    
    print("üîç Generando reporte de prueba con secci√≥n de explotaci√≥n...")
    success = reporter.generate(test_data, output_path, export_pdf=False)
    
    if success:
        print(f"‚úÖ Reporte generado exitosamente: {output_path}")
        print("\nüìä Resumen:")
        print(f"   - Total de vulnerabilidades: {len(test_data['all_findings'])}")
        print(f"   - Critical: {test_data['summary']['critical']}")
        print(f"   - High: {test_data['summary']['high']}")
        print(f"   - Medium: {test_data['summary']['medium']}")
        print(f"   - Low: {test_data['summary']['low']}")
        print(f"\nüí° Abre el archivo en tu navegador para ver la secci√≥n de explotaci√≥n:")
        print(f"   {os.path.abspath(output_path)}")
        
        # Verificar que el HTML contiene la secci√≥n de explotaci√≥n
        with open(output_path, 'r', encoding='utf-8') as f:
            content = f.read()
            if 'C√≥mo Explotar Esta Vulnerabilidad' in content:
                print("\n‚úÖ Secci√≥n de explotaci√≥n encontrada en el HTML")
            if 'Proof of Concept (POC)' in content:
                print("‚úÖ POCs incluidos en el reporte")
            if 'exploitation-section' in content:
                print("‚úÖ Estilos de explotaci√≥n aplicados")
        
        return True
    else:
        print("‚ùå Error al generar el reporte")
        return False

if __name__ == '__main__':
    test_exploitation_section()
